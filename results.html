<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>검사 결과</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 { text-align: center; color: #2c3e50; }
    #result-box {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 30px;
    }
    #result h2 { text-align: center; margin-top: 0; color: #4a90e2; }
    #nickname { text-align: center; font-size: 1.3rem; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
    #catchphrase { text-align: center; font-style: italic; margin-bottom: 20px; color: #666; }
    #description { text-align: center; margin-bottom: 30px; color: #444; }
    canvas { margin: 0 auto; display: block; max-width: 100%; height: auto !important; }
    a, button {
      display: block; text-align: center; margin: 20px auto 0; text-decoration: none; color: #fff;
      background: #4a90e2; padding: 10px 20px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer;
    }
    a:hover, button:hover { background: #357abd; }
    #saveBtn { background: #50c878; }
    #saveBtn:hover { background: #3da96a; }
  </style>
</head>
<body>
  <h1>검사 결과</h1>
  <div id="result-box">
    <div id="result"></div>
    <div style="position: relative; height: 320px;">
      <canvas id="scoreChart"></canvas>
    </div>
  </div>
  <button id="saveBtn">결과 이미지로 저장</button>
  <a href="index.html">다시 검사하기</a>

  <script>
    // --- typeData는 기존 그대로 ---
    const typeData = [/* 16개 유형 데이터 */];

    const params = new URLSearchParams(window.location.search);
    const scoresParam = params.get("scores");

    if (!scoresParam) {
      document.getElementById('result').innerHTML = "<p>결과 데이터를 찾을 수 없습니다.</p>";
    } else {
      const scores = scoresParam.split(",").map(Number);
      const adjustedScores = scores.map(s => s - 13);  // 13점을 0으로 맞춤

      const types = [];
      types[0] = scores[0] >= 13 ? "R형(교제형)" : "S형(묵상형)";
      types[1] = scores[1] >= 13 ? "E형(체험형)" : "W형(말씀형)";
      types[2] = scores[2] >= 13 ? "D형(관계중심형)" : "P형(원칙중심형)";
      types[3] = scores[3] >= 13 ? "O형(정돈형)" : "F형(유연형)";

      const descriptions = {
        "R": "사람들과 함께하는 것을 즐기고, 공동체 안에서 신앙을 키우는 스타일.",
        "S": "혼자서 깊이 묵상하고 개인적인 만남을 선호하는 스타일.",
        "E": "느낌과 체험을 중시하며 신앙을 생생하게 경험하는 스타일.",
        "W": "말씀과 이성을 중심으로 차분하게 접근하는 스타일.",
        "D": "하나님을 친밀한 아버지, 친구로 여기는 스타일.",
        "P": "하나님의 법과 기준을 중시하는 스타일.",
        "O": "계획적이고 체계적인 신앙생활을 선호하는 스타일.",
        "F": "자유롭고 융통성 있는 신앙생활을 선호하는 스타일."
      };

      const shortCodes = [types[0][0], types[1][0], types[2][0], types[3][0]];
      const finalType = shortCodes.join("-");
      const typeInfo = typeData.find(item => item.type === finalType);

      let detailHtml = `
        <p><strong>공동체 참여성향:</strong> ${types[0]} - ${descriptions[types[0][0]]}</p>
        <p><strong>신앙 표현방식:</strong> ${types[1]} - ${descriptions[types[1][0]]}</p>
        <p><strong>하나님 인식방식:</strong> ${types[2]} - ${descriptions[types[2][0]]}</p>
        <p><strong>신앙생활 패턴:</strong> ${types[3]} - ${descriptions[types[3][0]]}</p>
        <hr>
      `;

      let resultHtml = `
        <h2>최종 유형: ${finalType}</h2>
        ${detailHtml}
        <div id="nickname">${typeInfo ? typeInfo.nickname : ""}</div>
        <div id="catchphrase">${typeInfo ? typeInfo.catchphrase : ""}</div>
        <div id="description">${typeInfo ? typeInfo.description : ""}</div>
      `;

      document.getElementById('result').innerHTML = resultHtml;

      const ctx = document.getElementById('scoreChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ["R ↔ S", "E ↔ W", "D ↔ P", "O ↔ F"],
          datasets: [{
            label: '편차',
            data: adjustedScores,
            backgroundColor: ['#4a90e2','#50c878','#ffb347','#ff6666']
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const diff = context.raw;
                  const score = diff + 13;
                  const direction = score >= 13 ? "왼쪽 성향" : "오른쪽 성향";
                  return `${score}점 (${direction})`;
                }
              }
            }
          },
          scales: {
            x: {
              min: -8,
              max: 7,
              grid: { color: '#ddd' },
              ticks: {
                callback: function(value) {
                  if (value === -8) return "";
                  if (value === 7) return "";
                  return value;
                }
              }
            }
          }
        }
      });
    }

    document.getElementById('saveBtn').addEventListener('click', () => {
      const resultBox = document.getElementById('result-box');
      html2canvas(resultBox).then(canvas => {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = '신앙유형검사결과.png';
        link.click();
      });
    });
  </script>
</body>
</html>
