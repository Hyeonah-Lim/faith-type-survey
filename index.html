<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>SCTI 성락교회 성향검사 - Sungrak Church Type Indicator</title>
<!-- html2canvas 라이브러리 -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
        --primary:#5B72EE;--secondary:#FF6B9D;
        --background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        --text-dark:#2c3e50;--text-light:#495057;
        --gray-light:#f8f9fa;--gray-medium:#e9ecef;
        --circle-large-size:60px;--circle-small-size:40px;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--background);min-height:100vh;overflow-x:hidden;color:var(--text-dark)}
    .container{min-height:100vh;display:flex;flex-direction:column}
    /* 시작 화면 */
    .start-screen{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;padding:20px;text-align:center;color:#fff;position:relative;overflow:hidden;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .catchphrase{font-size:16px;opacity:.95;margin:20px 0;font-style:italic;letter-spacing:.5px;z-index:2}
    .logo{font-size:80px;margin-bottom:30px;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .start-screen h1{font-size:36px;font-weight:700;margin-bottom:10px}
    .start-screen .english-title{font-size:18px;opacity:.9;margin-bottom:25px;font-style:italic}
    .scti-explanation{background:rgba(255,255,255,.15);backdrop-filter:blur(10px);border-radius:20px;padding:25px;margin-bottom:30px;text-align:left;max-width:420px}
    .scti-explanation h3{font-size:20px;margin-bottom:15px;text-align:center}
    .scti-explanation .description{font-size:14px;line-height:1.6;text-align:center;margin-bottom:20px;opacity:.9}
    .scti-item{margin:12px 0;font-size:14px;line-height:1.5;display:flex;align-items:center;gap:10px}
    .scti-item .letter{background:#FFE66D;color:#764ba2;font-weight:700;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
    .start-btn{background:#fff;color:var(--primary);border:none;padding:18px 60px;border-radius:30px;font-size:18px;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .start-btn:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(0,0,0,.3)}
    .start-btn:active{transform:scale(.95)}
    /* 검사 화면 */
    .test-screen{display:none;background:#fff;min-height:100vh;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
    .header{background:var(--background);padding:20px;color:#fff;position:sticky;top:0;z-index:100;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .progress-container{background:rgba(255,255,255,.2);height:6px;border-radius:3px;overflow:hidden;margin-top:10px;max-width:420px;margin-left:auto;margin-right:auto}
    .progress-bar{height:100%;background:#fff;border-radius:3px;transition:width .4s ease;box-shadow:0 0 10px rgba(255,255,255,.5)}
    .question-container{padding:30px 20px 120px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 180px);text-align:center}
    .question-number{color:var(--primary);font-weight:600;font-size:14px;margin-bottom:15px}
    .question-text{font-size:22px;font-weight:600;line-height:1.5;margin-bottom:30px;color:var(--text-dark);text-align:center;max-width:90%}
    .options-scale{display:flex;align-items:center;justify-content:space-between;gap:15px;flex-wrap:nowrap;padding:0 10px;max-width:640px;margin:0 auto;width:100%}
    .option-text-wrapper{flex-basis:30%;flex-shrink:1;text-align:center;font-size:14px;color:var(--text-light);line-height:1.4;display:flex;align-items:center;justify-content:center;min-height:var(--circle-large-size);padding:10px;background:var(--gray-light);border-radius:12px;border:2px solid transparent;transition:.3s}
    .option-text-wrapper.selected-left,.option-text-wrapper.selected-right{background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));border-color:var(--primary);font-weight:500}
    .circle-wrapper{display:flex;align-items:center;justify-content:center;flex-grow:1;gap:10px}
    .option-circle-container{display:flex;flex-direction:column;align-items:center;justify-content:center;flex-basis:0;text-align:center;cursor:pointer;transition:.2s;padding:5px}
    .option-circle{border-radius:50%;background:var(--gray-light);border:2px solid var(--gray-medium);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.2s}
    .option-circle.large{width:var(--circle-large-size);height:var(--circle-large-size)}
    .option-circle.small{width:var(--circle-small-size);height:var(--circle-small-size)}
    input[type="radio"]{display:none}
    input[type="radio"]:checked + .option-circle-container .option-circle{background:var(--secondary);border-color:var(--secondary);transform:scale(1.1);box-shadow:0 4px 8px rgba(0,0,0,.2)}
    .option-circle-container:hover .option-circle{background:var(--gray-medium)}
    .mobile-text-display{display:none;margin-top:20px;padding:15px;background:var(--gray-light);border-radius:12px;max-width:90%;margin-left:auto;margin-right:auto}
    .left-indicator,.right-indicator{display:inline-block;padding:3px 8px;border-radius:4px;font-size:12px;font-weight:600;margin-bottom:5px;color:#fff}
    .left-indicator{background:linear-gradient(90deg,#667eea,#764ba2)}
    .right-indicator{background:linear-gradient(90deg,#764ba2,#667eea)}
    .navigation{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:15px 20px;box-shadow:0 -2px 15px rgba(0,0,0,.1);display:flex;gap:12px;z-index:100}
    .nav-btn{flex:1;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:.2s}
    .nav-btn.prev{background:var(--gray-medium);color:var(--text-light)}
    .nav-btn.next{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
    .nav-btn:disabled{opacity:.4;cursor:not-allowed}
    .nav-btn:active:not(:disabled){transform:scale(.96)}
    /* 결과 화면 */
    .result-screen{display:none;background:#fff;min-height:100vh;animation:fadeIn .5s ease}
    .result-header{background:var(--background);padding:50px 20px 60px;text-align:center;color:#fff;position:relative;overflow:hidden}
    .result-header::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:60px;background:#fff;border-radius:30px 30px 0 0}
    .type-badge{display:inline-block;background:rgba(255,255,255,.2);padding:8px 20px;border-radius:20px;font-size:14px;margin-bottom:20px}
    .type-code{font-size:48px;font-weight:800;margin:15px 0;letter-spacing:3px;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .type-emoji{font-size:64px;margin:20px 0;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.2))}
    .type-nickname{font-size:28px;font-weight:600;margin-bottom:30px}
    .result-content{padding:40px 20px}
    .card{background:var(--gray-light);border-radius:20px;padding:25px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .card h3{color:var(--text-dark);font-size:18px;margin-bottom:15px;display:flex;align-items:center;gap:8px}
    .card p{color:var(--text-light);line-height:1.7;font-size:15px}
    .traits{list-style:none;margin-top:15px}
    .traits li{padding:12px 0;color:var(--text-light);font-size:15px;display:flex;align-items:flex-start;gap:10px;border-bottom:1px solid var(--gray-medium)}
    .traits li:last-child{border-bottom:none}
    .traits li::before{content:'✨';flex-shrink:0}
    .score-visualization{background:#fff;border:2px solid var(--gray-medium);border-radius:20px;padding:25px;margin:20px 0}
    .score-row{margin:25px 0}
    .score-labels{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px}
    .score-label{color:var(--text-light);font-weight:600}
    .score-label.active{color:var(--primary);font-weight:700}
    .score-bar-container{position:relative;height:12px;background:var(--gray-medium);border-radius:6px;overflow:hidden}
    .score-bar-center{position:absolute;left:50%;top:0;bottom:0;width:3px;background:var(--text-dark);opacity:.7;z-index:1}
    .score-fill-left{position:absolute;right:50%;top:0;height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:6px 0 0 6px;transition:width 1s ease}
    .score-fill-right{position:absolute;left:50%;top:0;height:100%;background:linear-gradient(90deg,#764ba2,#667eea);border-radius:0 6px 6px 0;transition:width 1s ease}
    .actions{padding:20px 20px 40px}
    .action-btn{width:100%;padding:18px;border:none;border-radius:16px;font-size:16px;font-weight:600;cursor:pointer;transition:.2s;margin-bottom:12px}
    .action-btn.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
    .action-btn.secondary{background:var(--gray-light);color:var(--text-light)}
    .action-btn:active{transform:scale(.97)}
    .copyright{text-align:center;padding:20px;color:var(--text-light);font-size:12px;background:var(--gray-light);line-height:1.6}
    /* 결과 이미지 전용 캡처 카드(숨김, 캡처시만 보여줌) */
    .result-card-for-image{display:none;position:fixed;top:0;left:0;width:390px;min-height:844px;background:#fff;z-index:10000;overflow:hidden}
    .result-card-header{background:var(--background);padding:50px 20px 40px;text-align:center;color:#fff;position:relative}
    .result-card-header::after{content:'';position:absolute;bottom:-30px;left:0;right:0;height:60px;background:#fff;border-radius:30px 30px 0 0}
    .result-card-header .emoji{font-size:72px;margin-bottom:20px;filter:drop-shadow(2px 2px 4px rgba(0,0,0,.2))}
    .result-card-header .type-code{font-size:42px;font-weight:800;letter-spacing:3px;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .result-card-header .nickname{font-size:22px;font-weight:600;opacity:.95}
    .result-card-body{padding:40px 20px 30px;position:relative;z-index:1}
    .result-card-body .description{color:var(--text-dark);line-height:1.7;margin-bottom:20px;font-size:15px;text-align:center;padding:16px;background:var(--gray-light);border-radius:16px}
    .result-card-body .traits-title{font-size:18px;font-weight:700;color:var(--text-dark);margin-bottom:12px;text-align:center}
    .result-card-body .traits-list{list-style:none;padding:0;margin:0}
    .result-card-body .traits-list li{padding:10px;margin-bottom:10px;background:#fff;border:2px solid var(--gray-medium);border-radius:12px;font-size:14px;line-height:1.6;color:var(--text-dark);display:flex;align-items:flex-start;gap:10px}
    .result-card-body .traits-list li::before{content:'✨';flex-shrink:0;font-size:16px}
    .result-card-body .graph-title{font-size:16px;font-weight:700;margin:18px 0 8px;text-align:center}
    .result-card-body .mini-graph{background:#fff;border:2px solid var(--gray-medium);border-radius:16px;padding:16px}
    .result-card-footer{padding:12px 16px;background:var(--gray-light);color:var(--text-light);font-size:12px;text-align:center;border-top:1px solid var(--gray-medium)}
    @media(min-width:768px){.container{max-width:680px;margin:0 auto;box-shadow:0 0 50px rgba(0,0,0,.08)}}
    @media(max-width:767px){
        .options-scale{flex-direction:column;align-items:center;gap:20px;padding:0 5px}
        .option-text-wrapper{display:none}
        .mobile-text-display{display:block}
        .circle-wrapper{width:100%;justify-content:center;gap:8px}
        .option-circle.large{width:55px;height:55px}
        .option-circle.small{width:35px;height:35px}
        .question-text{font-size:20px;margin-bottom:20px}
    }
</style>
</head>
<body>
<div class="container">
    <!-- 시작 화면 -->
    <div class="start-screen" id="startScreen">
        <div class="catchphrase">나만의 독특한 신앙 스타일을 발견해보세요</div>
        <div class="logo">⛪</div>
        <h1>SCTI 성락교회 성향검사</h1>
        <div class="english-title">Sungrak Church Type Indicator</div>

        <div class="scti-explanation">
            <h3>🔍 SCTI란?</h3>
            <p class="description">성락교회 공동체 안에서 나의 신앙 성향을 알아보는 검사입니다</p>
            <div class="scti-item"><div class="letter">S</div><div>Social - 공동체 참여 성향 (R/S)</div></div>
            <div class="scti-item"><div class="letter">C</div><div>Character - 신앙 표현 방식 (E/W)</div></div>
            <div class="scti-item"><div class="letter">T</div><div>Theology - 하나님 인식 방식 (D/P)</div></div>
            <div class="scti-item"><div class="letter">I</div><div>Implementation - 신앙생활 패턴 (O/F)</div></div>
        </div>

        <button class="start-btn" onclick="startTest()">시작하기</button>
        <div style="margin-top:30px;font-size:14px;opacity:.85">⏱ 약 5분 소요 | 📝 20문항</div>
    </div>

    <!-- 검사 화면 -->
    <div class="test-screen" id="testScreen">
        <div class="header">
            <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        </div>

        <div class="question-container">
            <div class="question-number" id="questionNumber"></div>
            <div class="question-text" id="questionText"></div>
            <div class="options-scale" id="optionsContainer"></div>

            <!-- 모바일 전용 텍스트 표시 -->
            <div class="mobile-text-display" id="mobileTextDisplay" style="display:none;">
                <div><span class="left-indicator">◀ 왼쪽</span>
                    <p id="mobileLeftText" style="margin:5px 0;font-size:14px;"></p></div>
                <div style="margin-top:15px;"><span class="right-indicator">오른쪽 ▶</span>
                    <p id="mobileRightText" style="margin:5px 0;font-size:14px;"></p></div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-btn prev" id="prevBtn" onclick="goPrev()" disabled>이전</button>
            <button class="nav-btn next" id="nextBtn" onclick="goNext()" disabled>다음</button>
        </div>
    </div>

    <!-- 결과 화면 -->
    <div class="result-screen" id="resultScreen">
        <div class="result-header">
            <div class="type-badge" id="typeBadge">SCTI 결과</div>
            <div class="type-emoji" id="resultEmoji">✨</div>
            <div class="type-code" id="resultCode">REDF</div>
            <div class="type-nickname" id="resultNickname">별명</div>
        </div>

        <div class="result-content">
            <div class="card">
                <h3>요약 설명</h3>
                <p id="resultDescription">설명</p>
            </div>

            <div class="card score-visualization" id="scoreBox">
                <h3>상세 분석 그래프</h3>
                <div id="scoresArea"></div>
            </div>

            <div class="card">
                <h3>특징</h3>
                <ul class="traits" id="traitList"></ul>
            </div>
        </div>

        <div class="actions">
            <button class="action-btn primary" onclick="downloadResultImage()">결과 이미지 저장 (그래프 포함)</button>
            <button class="action-btn secondary" onclick="restart()">다시 검사하기</button>
        </div>

        <div class="copyright">
            <strong>SCTI</strong> | Sungrak Church Type Indicator<br/>
            결과 이미지는 개인 기록 및 나눔 용도로 활용하실 수 있습니다.
        </div>
    </div>

    <!-- 다운로드용 숨김 카드(그래프 포함 캡처영역) -->
    <div class="result-card-for-image" id="imageCard">
        <div class="result-card-header">
            <div class="emoji" id="imgEmoji">✨</div>
            <div class="type-code" id="imgCode">REDF</div>
            <div class="nickname" id="imgNickname">닉네임</div>
        </div>
        <div class="result-card-body">
            <div class="description" id="imgDescription">설명</div>

            <div class="graph-title">상세 분석 그래프</div>
            <div class="mini-graph" id="imgGraph"></div>

            <div class="traits-title">특징</div>
            <ul class="traits-list" id="imgTraits"></ul>
        </div>
        <div class="result-card-footer">SCTI • Sungrak Church Type Indicator</div>
    </div>
</div>

<script>
/* ===================== 1) 질문 원본(정확히 20문항) ===================== */
const baseQuestions = [
  // 공동체 참여 성향 (R/S) — 5
  { category:'공동체 참여 성향', text:'🎵 성가대 연습에 10분 늦은 당신! 모두가 먼저 와 있고, 당신만 눈치 보며 들어간 상황에서…',
    leftText:'가볍게 사과하고 주변에 자연스럽게 섞이는 편이다.', rightText:'누구도 말 안 걸었으면 하고 그냥 묵묵히 앉아있는 편이다.', leftType:'R', rightType:'S' },
  { category:'공동체 참여 성향', text:'🙋 청년부에 새로 온 지체가 혼자 앉아있다.',
    leftText:'반가운 마음으로 먼저 다가가 말을 건넨다.', rightText:'어색해서 다가가긴 어렵지만 조용히 관심을 갖고 기회가 되면 개인적으로 대화한다.', leftType:'R', rightType:'S' },
  { category:'공동체 참여 성향', text:'📆 수련회에 참석하게 된 당신, 가장 기대하는 것은?',
    leftText:'많은 사람들과 함께 뜨거운 예배를 드리는 것', rightText:'혼자만의 시간에 뜨겁게 기도하는 것', leftType:'R', rightType:'S' },
  { category:'공동체 참여 성향', text:'🧠 신앙적인 고민이 깊어진 시기, 당신은?',
    leftText:'신앙 친구들과 나누며 함께 기도한다.', rightText:'혼자 하나님께 기도하며 답을 구한다.', leftType:'R', rightType:'S' },
  { category:'공동체 참여 성향', text:'❓ 교회 재정이나 헌금에 대해 내 마음은?',
    leftText:'공동체가 함께 사용하는 것이라 기꺼이 나누고 싶은 마음이다.', rightText:'조용히 하나님 앞에서 결정하고 헌금은 개인적인 헌신이라고 생각한다.', leftType:'R', rightType:'S' },

  // 신앙 표현방식 (E/W) — 5
  { category:'신앙 표현방식', text:'🎤 썸워십에 참석한 당신, 어떤 스타일인가요?',
    leftText:'몸으로 표현하며 감정이 우러나는 찬양을 좋아한다', rightText:'가사의 의미를 생각하며 조용히 마음으로 부른다', leftType:'E', rightType:'W' },
  { category:'신앙 표현방식', text:'📖 말씀 듣는 중, 당신의 자세는?',
    leftText:'말씀을 통해 받은 감동과 느낌을 중심으로 정리한다.', rightText:'논리적 흐름과 단어의 뜻을 구조적으로 정리한다.', leftType:'E', rightType:'W' },
  { category:'신앙 표현방식', text:'🙏 기도응답을 경험했을 때',
    leftText:'하나님이 살아계심을 느꼈다는 체험에 집중한다.', rightText:'하나님의 뜻이 무엇인지 깨달은 것에 집중한다.', leftType:'E', rightType:'W' },
  { category:'신앙 표현방식', text:'💬 수련회 이후, 목장 사람들과 함께 간증 나눔을 하게 된 당신',
    leftText:'하나님을 경험한 순간의 감정과 느낌을 자세히 나눈다', rightText:'하나님이 어떤 방법으로 역사하셨는지 사실 중심으로 나눈다', leftType:'E', rightType:'W' },
  { category:'신앙 표현방식', text:'💰 재정이나 시간의 우선순위를 정할 때 기준은?',
    leftText:'마음속에서 하나님이 주신 감동이나 흐름을 따른다.', rightText:'말씀을 통해 배우고 적용한 원칙을 중심으로 판단한다.', leftType:'E', rightType:'W' },

  // 하나님 인식방식 (D/P) — 5
  { category:'하나님 인식방식', text:'📖 성경을 읽을 때 가장 먼저 드는 감정은?',
    leftText:'하나님이 내게 말 걸어 주시는 듯한 친밀감을 느끼는 편이다', rightText:'하나님의 명령과 기준이 무엇인지 찾는 편이다', leftType:'D', rightType:'P' },
  { category:'하나님 인식방식', text:'🙏 기도할 때, 당신은 하나님을 어떻게 그리는가?',
    leftText:'내가 힘들 때 안아 주시는 따뜻한 분', rightText:'내 삶을 판단하고 이끄시는 기준이자 주권자', leftType:'D', rightType:'P' },
  { category:'하나님 인식방식', text:'🧭 믿음의 결정을 내려야 할 때, 당신은?',
    leftText:'마음에 평안이 있는지를 중심으로 분별한다.', rightText:'말씀의 기준에 맞는지를 따져본다.', leftType:'D', rightType:'P' },
  { category:'하나님 인식방식', text:'✝️ 신앙생활의 주된 동기는',
    leftText:'하나님과의 더 깊은 사랑의 관계를 위해', rightText:'하나님이 기뻐하시는 올바른 삶을 살기 위해', leftType:'D', rightType:'P' },
  { category:'하나님 인식방식', text:'🙌 하나님께 헌신을 결단할 때, 어떤 마음이 앞서는가?',
    leftText:'하나님께 사랑받고 있다는 감격이 헌신의 원동력이다.', rightText:'하나님의 뜻에 순종하는 것이 당연하다는 책임감이 앞선다.', leftType:'D', rightType:'P' },

  // 신앙생활 패턴 (O/F) — 5
  { category:'신앙생활 패턴', text:'📆 수련회 전날 밤, 당신은?',
    leftText:'짐, 일정, 말씀 다 정리하고 기도까지 마친 상태다.', rightText:'마음 가는 대로 내일 아침에 짐 싸도 괜찮다.', leftType:'O', rightType:'F' },
  { category:'신앙생활 패턴', text:'📖 성경 읽기를 시작하려는 당신.',
    leftText:'계획표를 세워 하루 분량을 지키려고 노력하는 편이다.', rightText:'마음에 끌리는 본문 위주로 자유롭게 읽는 편이다.', leftType:'O', rightType:'F' },
  { category:'신앙생활 패턴', text:'📝 기도제목을 기록하는 방식은?',
    leftText:'날짜별로 정리된 노트나 앱을 사용하는 편이다.', rightText:'떠오를 때 간단히 메모하는 편이다.', leftType:'O', rightType:'F' },
  { category:'신앙생활 패턴', text:'⛪ 신앙생활을 실천하는 나만의 방식은?',
    leftText:'신앙생활은 계획적으로 실천하는 것이 중요하다고 생각한다.', rightText:'신앙생활은 흐름에 따라 자연스럽게 이어지는 것이 더 의미 있다고 생각한다.', leftType:'O', rightType:'F' },
  { category:'신앙생활 패턴', text:'🎁 헌금이나 봉사를 할 때의 나는?',
    leftText:'미리 계획하고 정해둔 방식대로 정기적으로 실천한다.', rightText:'마음이 감동되었을 때 자발적으로 드리고 참여하는 편이다.', leftType:'O', rightType:'F' },
];

/* ===================== 2) 결과 유형 사전(16종) ===================== */
const resultTypes = {
  'REDO':{emoji:'💖',nickname:'사랑 넘치는 공동체 리더',
    description:'공동체 속에서 사랑과 감정으로 신앙을 표현하며, 하나님과의 친밀한 관계를 통해 삶을 계획하고 실천하는 유형입니다.',
    traits:['공동체 활동에 적극적으로 참여하고 사람들과의 관계를 중요하게 생각합니다.','감성적이고 경험을 중시하며, 찬양과 기도를 통해 깊은 감동을 받습니다.','하나님을 사랑이 많고 친밀한 분으로 인식합니다.','신앙생활을 계획적으로 실천합니다.']},
  'REDF':{emoji:'🌊',nickname:'자유로운 사랑의 파도',
    description:'공동체 속에서 사랑을 나누고 감정적으로 신앙을 표현하며, 하나님과의 친밀한 관계 속에서 자유롭게 헌신하는 유형입니다.',
    traits:['공동체에서 에너지를 얻습니다.','감성·경험을 중시합니다.','하나님을 친밀한 분으로 인식합니다.','자발적으로 유연하게 실천합니다.']},
  'REPO':{emoji:'🌈',nickname:'감격의 무지개',
    description:'공동체 안에서 감정적으로 신앙을 표현하며, 하나님을 원칙 중심으로 인식하고 계획적으로 실천하는 유형입니다.',
    traits:['공동체에 적극적입니다.','경험을 중시합니다.','하나님을 공의의 하나님으로 인식합니다.','계획적으로 실천합니다.']},
  'REPF':{emoji:'🌻',nickname:'자유로운 감성의 꽃',
    description:'공동체 안에서 감성적으로 표현하고 원칙을 중시하되 유연하게 실천하는 유형입니다.',
    traits:['공동체 중심','감성·경험 중시','원칙 인식','자발·유연 실천']},
  'RWDO':{emoji:'🔍',nickname:'탐구하는 지식의 샘',
    description:'관계를 중시하고 이성적으로 신앙을 표현하며, 친밀한 관계를 통해 계획적으로 실천하는 유형입니다.',
    traits:['지적 교류 선호','논리 탐구','하나님을 친밀한 분으로 인식','계획적 실천']},
  'RWDF':{emoji:'🌬️',nickname:'고요한 성찰의 바람',
    description:'관계를 소중히 여기며 이성적으로 표현하고, 친밀한 관계 속에서 유연하게 헌신하는 유형입니다.',
    traits:['관계 소중','논리 탐구','친밀 인식','유연 실천']},
  'RWPO':{emoji:'💎',nickname:'진리의 보석',
    description:'관계를 소중히 여기며 이성적으로 이해하고, 원칙 중심으로 계획적으로 실천하는 유형입니다.',
    traits:['관계 소중','이성적 이해','원칙 인식','계획적 실천']},
  'RWPF':{emoji:'🌌',nickname:'이성적인 자유의 우주',
    description:'관계를 소중히 여기며 이성적으로 이해하고, 원칙을 중시하되 유연하게 실천하는 유형입니다.',
    traits:['관계 소중','이성적 이해','원칙 인식','유연 실천']},
  'SEDO':{emoji:'💡',nickname:'감성적인 지혜의 등대',
    description:'개인 묵상과 감정적 경험을 중시하며, 친밀한 관계를 통해 계획적으로 실천하는 유형입니다.',
    traits:['개인 교제 깊음','감성·경험 중시','친밀 인식','계획적 실천']},
  'SEDF':{emoji:'🌸',nickname:'고요한 감성의 샘',
    description:'개인 묵상과 감성적 경험을 중시하며, 친밀한 관계 속에서 유연하게 헌신하는 유형입니다.',
    traits:['개인 교제','감성·경험','친밀 인식','유연 실천']},
  'SEPO':{emoji:'🔥',nickname:'내면의 열정가',
    description:'개인 묵상을 중시하며, 하나님을 원칙 중심으로 인식하고 계획적으로 실천하는 유형입니다.',
    traits:['개인 교제','감성 중심 표현','원칙 인식','계획적 실천']},
  'SEPF':{emoji:'🕊️',nickname:'고요한 영혼의 탐험가',
    description:'개인 묵상을 중시하며, 원칙을 인식하되 유연하게 실천하는 유형입니다.',
    traits:['개인 교제','감성 중심 표현','원칙 인식','유연 실천']},
  'SWDO':{emoji:'📚',nickname:'말씀 중심의 실천가',
    description:'개인 묵상과 이성적 이해를 통해, 친밀한 관계로 계획적으로 실천하는 유형입니다.',
    traits:['개인 교제','논리 탐구','친밀 인식','계획적 실천']},
  'SWDF':{emoji:'🌳',nickname:'고요한 믿음의 나무',
    description:'개인 묵상과 이성적 이해를 통해, 친밀한 관계 속 유연한 실천을 추구하는 유형입니다.',
    traits:['개인 교제','논리 탐구','친밀 인식','유연 실천']},
  'SWPO':{emoji:'🌟',nickname:'빛나는 순종의 별',
    description:'개인 묵상과 이성적 이해를 통해, 원칙 중심으로 계획적으로 실천하는 유형입니다.',
    traits:['개인 교제','논리 탐구','원칙 인식','계획적 실천']},
  'SWPF':{emoji:'⛰️',nickname:'흔들림 없는 산',
    description:'개인 묵상과 이성적 이해를 통해, 원칙을 중시하되 유연하게 실천하는 유형입니다.',
    traits:['개인 교제','논리 탐구','원칙 인식','유연 실천']},
};

/* ===================== 3) 전역 상태 ===================== */
let questions = [];                 // 섞인 질문
let currentQuestionIndex = 0;
let userAnswers = [];               // 각 문항 선택(0~3)
let netScores = { RS:0, EW:0, DP:0, OF:0 }; // 누적 가중치(-10~+10)

/* ===================== 4) 유틸: 동일 카테고리 연속 없이 섞기 ===================== */
function noAdjacency(arr){
  for(let i=1;i<arr.length;i++){
    if(arr[i].category === arr[i-1].category) return false;
  }
  return true;
}
function fisherYates(a){
  const arr=a.slice();
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function greedyDistribute(a){
  const groups={};
  a.forEach(q=>{(groups[q.category]??=[]).push(q)});
  Object.values(groups).forEach(g=>g.sort(()=>Math.random()-0.5));
  const cats=Object.keys(groups);
  const res=[];
  let prev=null;
  for(let k=0;k<a.length;k++){
    const candidates=cats.filter(c=>groups[c].length>0 && c!==prev)
                         .sort((c1,c2)=>groups[c2].length - groups[c1].length);
    let pick=null;
    if(candidates.length>0){ pick=candidates[0]; }
    else{
      // 불가피하게 같은 카테고리면 이후 위치와 스왑 시도
      pick=cats.find(c=>groups[c].length>0);
    }
    res.push(groups[pick].pop());
    prev=pick;
  }
  return res;
}
function shuffleNoAdjacency(a){
  // 1) 시도형
  for(let t=0;t<1200;t++){
    const s=fisherYates(a);
    if(noAdjacency(s)) return s;
  }
  // 2) 그리디
  const g=greedyDistribute(a);
  if(noAdjacency(g)) return g;
  // 3) 마지막 보정 스왑
  for(let i=1;i<g.length;i++){
    if(g[i].category===g[i-1].category){
      const j=g.findIndex((x,idx)=> idx!==i && idx!==i-1 && x.category!==g[i].category);
      if(j>-1){ [g[i],g[j]]=[g[j],g[i]]; }
    }
  }
  return g;
}

/* ===================== 5) 시작/렌더/이동 ===================== */
function startTest(){
  document.getElementById('startScreen').style.display='none';
  document.getElementById('testScreen').style.display='flex';

  questions = shuffleNoAdjacency(baseQuestions);
  currentQuestionIndex = 0;
  userAnswers = new Array(questions.length).fill(null);
  netScores = { RS:0, EW:0, DP:0, OF:0 };

  renderQuestion();
  updateProgress();
}

function axisKeyOf(q){
  const pair = q.leftType + q.rightType; // 예: 'RS', 'EW', ...
  if(pair.includes('R') && pair.includes('S')) return 'RS';
  if(pair.includes('E') && pair.includes('W')) return 'EW';
  if(pair.includes('D') && pair.includes('P')) return 'DP';
  if(pair.includes('O') && pair.includes('F')) return 'OF';
  return null;
}

// 4점 척도 인덱스별 가중치: [왼강, 왼약, 오른약, 오른강] -> [+2,+1,-1,-2]
const weightByIndex = [ +2, +1, -1, -2 ];

function renderQuestion(){
  const q = questions[currentQuestionIndex];
  const qNum = document.getElementById('questionNumber');
  const qText= document.getElementById('questionText');
  const cont = document.getElementById('optionsContainer');

  qNum.textContent = `${currentQuestionIndex+1} / ${questions.length}`;
  qText.textContent = q.text;
  cont.innerHTML = '';

  const leftTextWrapper = document.createElement('div');
  leftTextWrapper.className = 'option-text-wrapper left-text';
  leftTextWrapper.innerHTML = `<p>${q.leftText}</p>`;
  cont.appendChild(leftTextWrapper);

  const circleWrapper = document.createElement('div');
  circleWrapper.className = 'circle-wrapper';

  const mobileDisplay = document.getElementById('mobileTextDisplay');
  const mobileLeftText = document.getElementById('mobileLeftText');
  const mobileRightText= document.getElementById('mobileRightText');
  if(window.innerWidth <= 767){
    mobileDisplay.style.display='block';
    mobileLeftText.textContent=q.leftText;
    mobileRightText.textContent=q.rightText;
  } else {
    mobileDisplay.style.display='none';
  }

  // 네 개의 원형 버튼 생성
  const optionMeta = [
    { label:'왼쪽(강)', size:'large'  }, // index 0
    { label:'왼쪽(약)', size:'small'  }, // index 1
    { label:'오른(약)', size:'small'  }, // index 2
    { label:'오른(강)', size:'large'  }, // index 3
  ];

  optionMeta.forEach((m,idx)=>{
    const input = document.createElement('input');
    input.type='radio';
    input.name=`question-${currentQuestionIndex}`;
    input.id=`q${currentQuestionIndex}-opt${idx}`;

    const wrap = document.createElement('label'); // 클릭영역 확장
    wrap.htmlFor = input.id;

    const cont2 = document.createElement('div');
    cont2.className='option-circle-container';

    const circle = document.createElement('div');
    circle.className=`option-circle ${m.size}`;

    cont2.appendChild(circle);
    wrap.appendChild(cont2);

    // 선택 이벤트
    input.addEventListener('change', ()=>{
      userAnswers[currentQuestionIndex] = idx;
      updateSelectedTextHighlight(idx);
      document.getElementById('nextBtn').disabled = false;
    });

    circleWrapper.appendChild(input);
    circleWrapper.appendChild(wrap);
  });
  cont.appendChild(circleWrapper);

  const rightTextWrapper = document.createElement('div');
  rightTextWrapper.className = 'option-text-wrapper right-text';
  rightTextWrapper.innerHTML = `<p>${q.rightText}</p>`;
  cont.appendChild(rightTextWrapper);

  // 이전 응답 복원
  const saved = userAnswers[currentQuestionIndex];
  document.getElementById('nextBtn').disabled = (saved===null);
  if(saved!==null){
    const input = document.getElementById(`q${currentQuestionIndex}-opt${saved}`);
    if(input){ input.checked = true; updateSelectedTextHighlight(saved); }
  }

  // 이전 버튼 상태
  document.getElementById('prevBtn').disabled = (currentQuestionIndex===0);
}

function updateSelectedTextHighlight(selectedIdx){
  const leftText = document.querySelector('.option-text-wrapper.left-text');
  const rightText= document.querySelector('.option-text-wrapper.right-text');
  leftText.classList.remove('selected-left');
  rightText.classList.remove('selected-right');
  if(selectedIdx===0 || selectedIdx===1) leftText.classList.add('selected-left');
  if(selectedIdx===2 || selectedIdx===3) rightText.classList.add('selected-right');
}

function goPrev(){
  if(currentQuestionIndex>0){
    currentQuestionIndex--;
    renderQuestion();
    updateProgress();
  }
}
function goNext(){
  if(userAnswers[currentQuestionIndex]===null) return;

  if(currentQuestionIndex < questions.length-1){
    currentQuestionIndex++;
    renderQuestion();
    updateProgress();
  }else{
    // 마지막 -> 결과 계산
    calculateScores();
    showResult();
  }
}

function updateProgress(){
  const progress = ((currentQuestionIndex) / questions.length)*100;
  document.getElementById('progressBar').style.width = `${progress}%`;
}

/* ===================== 6) 점수 계산/결과 도출 ===================== */
function calculateScores(){
  netScores = { RS:0, EW:0, DP:0, OF:0 };
  for(let i=0;i<questions.length;i++){
    const q = questions[i];
    const idx = userAnswers[i];
    if(idx===null) continue;
    const w = weightByIndex[idx];
    const axis = axisKeyOf(q); // 'RS' 등
    if(!axis) continue;

    // 왼쪽 타입이면 +, 오른쪽 타입이면 -
    // 이미 weightByIndex가 [+2,+1,-1,-2]이므로 그대로 합산
    netScores[axis] += w;
  }
}

function letterForAxis(axisKey, value){
  // value>0 -> 왼쪽 글자, value<0 -> 오른쪽 글자
  if(axisKey==='RS') return value>=0 ? 'R' : 'S';
  if(axisKey==='EW') return value>=0 ? 'E' : 'W';
  if(axisKey==='DP') return value>=0 ? 'D' : 'P';
  if(axisKey==='OF') return value>=0 ? 'O' : 'F';
  return '?';
}

function showResult(){
  // 진행바 가득
  document.getElementById('progressBar').style.width='100%';
  document.getElementById('testScreen').style.display='none';
  document.getElementById('resultScreen').style.display='block';

  // 각 축 최대값 = 문항수(축별 5문항)*2
  const maxPerAxis = 5*2; // 10
  const code = letterForAxis('RS',netScores.RS) + letterForAxis('EW',netScores.EW)
              + letterForAxis('DP',netScores.DP) + letterForAxis('OF',netScores.OF);

  const info = resultTypes[code] ?? {
    emoji:'✨', nickname:'SCTI 유형',
    description:'각 축의 우세 방향을 바탕으로 도출된 유형입니다.',
    traits:['관계/개인, 감성/이성, 사랑/원칙, 계획/유연의 균형을 추구합니다.']
  };

  // 헤더
  document.getElementById('resultEmoji').textContent = info.emoji;
  document.getElementById('resultCode').textContent  = code;
  document.getElementById('resultNickname').textContent = info.nickname;
  document.getElementById('resultDescription').textContent = info.description;

  // 특징
  const traitUL = document.getElementById('traitList');
  traitUL.innerHTML = '';
  info.traits.forEach(t=>{
    const li=document.createElement('li');
    li.textContent=t;
    traitUL.appendChild(li);
  });

  // 상세 그래프 DOM
  renderScoreBars('scoresArea', netScores, maxPerAxis);

  // 다운로드 카드 데이터 동기화
  syncImageCard(code, info, netScores, maxPerAxis);
}

function renderScoreBars(containerId, scores, maxPerAxis){
  const area = document.getElementById(containerId);
  area.innerHTML='';
  const rows = [
    { key:'RS', left:'관계지향 R', right:'개인지향 S', value:scores.RS },
    { key:'EW', left:'감성표현 E', right:'이성표현 W', value:scores.EW },
    { key:'DP', left:'사랑중심 D', right:'원칙중심 P', value:scores.DP },
    { key:'OF', left:'계획중심 O', right:'유연중심 F', value:scores.OF },
  ];
  rows.forEach(r=>{
    const row = document.createElement('div');
    row.className='score-row';

    const labels = document.createElement('div');
    labels.className='score-labels';
    const l = document.createElement('div'); l.className='score-label'; l.textContent=r.left;
    const m = document.createElement('div'); m.className='score-label'; m.textContent = `${r.value}`;
    const rt= document.createElement('div'); rt.className='score-label'; rt.textContent=r.right;
    // 활성화 표시
    if(r.value>0) l.classList.add('active');
    if(r.value<0) rt.classList.add('active');

    labels.appendChild(l); labels.appendChild(m); labels.appendChild(rt);

    const bar = document.createElement('div'); bar.className='score-bar-container';
    const center = document.createElement('div'); center.className='score-bar-center';
    const fillL = document.createElement('div'); fillL.className='score-fill-left';
    const fillR = document.createElement('div'); fillR.className='score-fill-right';

    const pct = Math.min(1, Math.abs(r.value)/maxPerAxis) * 50; // 한쪽 최대 50%
    fillL.style.width = (r.value>0)? `${pct}%` : '0%';
    fillR.style.width = (r.value<0)? `${pct}%` : '0%';

    bar.appendChild(fillL); bar.appendChild(center); bar.appendChild(fillR);

    row.appendChild(labels);
    row.appendChild(bar);
    area.appendChild(row);
  });
}

/* ===================== 7) 결과 이미지(그래프 포함) 저장 ===================== */
function syncImageCard(code, info, scores, maxPerAxis){
  document.getElementById('imgEmoji').textContent = info.emoji;
  document.getElementById('imgCode').textContent  = code;
  document.getElementById('imgNickname').textContent = info.nickname;
  document.getElementById('imgDescription').textContent = info.description;

  // 미니 그래프 렌더
  const g = document.getElementById('imgGraph');
  g.innerHTML = '';
  // 동일한 구성 사용
  const temp = document.createElement('div');
  temp.id = 'imgGraphInner';
  g.appendChild(temp);
  renderScoreBars('imgGraphInner', scores, maxPerAxis);

  // 특징
  const ul = document.getElementById('imgTraits');
  ul.innerHTML='';
  (info.traits||[]).forEach(t=>{
    const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);
  });
}

async function downloadResultImage(){
  const card = document.getElementById('imageCard');
  card.style.display='block'; // 화면 밖 고정 위치

  // 약간의 렌더링 여유
  await new Promise(r=>setTimeout(r, 150));

  const canvas = await html2canvas(card, {useCORS:true, backgroundColor:'#ffffff', scale:2});
  const dataURL = canvas.toDataURL('image/png');

  const a = document.createElement('a');
  a.href = dataURL;
  a.download = `SCTI_result_${new Date().toISOString().slice(0,10)}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  card.style.display='none';
}

/* ===================== 8) 재시작 ===================== */
function restart(){
  document.getElementById('resultScreen').style.display='none';
  document.getElementById('startScreen').style.display='flex';
}

/* ===================== 9) 초기 진입시 버튼 비활성화 안전장치 ===================== */
window.addEventListener('load', ()=>{
  document.getElementById('nextBtn').disabled = true;
});
</script>
</body>
</html>
